(function(global,factory){if(typeof module==="object"&&typeof module.exports==="object"){module.exports=global.document?factory(global,true):function(w){if(!w.document){throw new Error("SM requires a window with a document")}return factory(w)}}else{factory(global)}}(typeof window!=="undefined"?window:this,function(window){var _reg={braceReg:/\{\{(.*)\}\}/,smReg:/^(sm\-)|(\:)|(\@)/,hasSymbolReg:/(\+)+|(\-)+|(\[)+|(\])+|(\.)+|(\%)+|(\!)+|(\&)+|(\*)+|(\<)+|(\>)+|(\?)+|(\/)+/,},_ob={},_listVer={},_listName="list",_listItemName="item",_listIndexName="index",_newArrProto=[],_type={"sm-text":"text","sm-model":"input","sm-on":"event","sm-bind":"bind","sm-for":"for","sm-html":"html","sm-if":"if","sm-show":"show",};var getHash=(function(){var hash=0;return function(){return hash++}})();function addEvent(eles,type,handler){if(eles.length){for(var j=0;j<eles.length;j++){setEvent(eles[j])}}else{setEvent(eles)}function setEvent(ele){if(ele.addEventListener){ele.addEventListener(type,handler,false)}else{if(ele.attachEvent){ele.attachEvent("on"+type,handler)}else{return false}}}}function hasClass(obj,cls){return obj.className.match(new RegExp("(\\s|^)"+cls+"(\\s|$)"))}function addClass(obj,cls){if(!hasClass(obj,cls)){obj.className+=" "+cls}}function removeClass(obj,cls){if(hasClass(obj,cls)){var reg=new RegExp("(\\s|^)"+cls+"(\\s|$)");obj.className=obj.className.replace(reg,"")}}function trimAll(str){return str.replace(/\s/g,"")}function strToObj(str){return JSON.parse(trimAll(str).replace(/^\{/g,'{"').replace(/\}$/g,'"}').replace(/\:/g,'":"').replace(/\,/g,'","'))}var arrayProto=Array.prototype;var arrayMethods=Object.create(arrayProto);["push","pop","shift","unshift","splice","sort","reverse"].forEach(function(method){var original=arrayMethods[method];_newArrProto[method]=function mutator(){var length=original.apply(this,arguments);_ob.arrDep.notify();return length}});function compile(node,_sm,ofList){var isKeepOnScan=true;if(node.nodeType===1){var attr=node.attributes;for(var i=0;i<attr.length;i++){var name=(attr[i].nodeName).trim();var str=(attr[i].nodeValue).trim();if(_reg.smReg.test(name)){node.removeAttribute(name);i--;var tVal,isHas=name.indexOf(":")!==-1?0:name.substring(0,1)==="@"?1:-1;if(isHas!==-1){var arr=isHas===0?name.split(":"):name.split("@");if((tVal=_type[arr[0]])==="event"||isHas===1){_sm.render=createFunction(getEventRender(str));var callback=_sm.render();addEvent(node,arr[1],function(e){callback.call(_sm,e)})}else{if(tVal==="bind"||arr[0]===""){if(arr[1]==="style"||arr[1]==="class"){var obj=strToObj(str);for(key in obj){new Watcher({_sm:_sm,node:node,ofList:ofList,type:"bind",bindType:arr[1],key:obj[key],bindName:key})}}else{new Watcher({_sm:_sm,node:node,ofList:ofList,type:"bind",bindType:"attr",key:str,bindName:arr[1]})}}}}else{if(tVal=_type[name]){var key=trimAll(str);new Watcher({_sm:_sm,node:node,key:key,ofList:ofList,type:tVal,});if(tVal==="for"){node.parentNode.removeChild(node);isKeepOnScan=false}if(tVal==="input"){addEvent(node,tVal,function(e){_sm.$data[key]=e.target.value})}}}}}}else{if(node.nodeType===3){if(_reg.braceReg.test(node.nodeValue)){str=RegExp.$1.trim();var key=trimAll(str);node.nodeValue=_sm[key];new Watcher({_sm:_sm,node:node,key:key,ofList:ofList,type:"{{}}",})}}}return isKeepOnScan}function viewScan(nodes,_sm,ofList,isOut){if(isOut){compile(nodes,_sm,ofList)}for(var i=0;i<nodes.childNodes.length;i++){if(Dep.listLength&&!Dep.listInfo){i+=Dep.listLength-1;Dep.listLength=null}if(compile(nodes.childNodes[i],_sm,ofList)){viewScan(nodes.childNodes[i],_sm,ofList)}}}function watchData(_sm,key,value){var dep=new Dep(),info=objInfo(value);if(info===2){_sm.$data[key].__proto__=_newArrProto}Object.defineProperty(_sm.$data,key,{enumerable:true,configurable:true,set:function reactiveSetter(newVal){if(newVal===value){return}value=newVal;_sm.__data__[key]=newVal;dep.notify()},get:function reactiveGetter(){if(Dep.watcher){dep.addWatch(Dep.watcher);if(info===2){_ob.arrDep.addWatch(Dep.watcher)}}return value}});_sm[key]=_sm.$data[key];Object.defineProperty(_sm,key,{enumerable:true,configurable:true,set:function proxySetter(newVal){if(_sm.$data[key]===newVal){return}_sm.$data[key]=newVal},get:function proxyGetter(){return _sm.$data[key]}})}function getRender(code){return("with(this){return "+compilerCode(code)+"}")}function getEventRender(code){return("with(this){ return function($event){"+compilerCode(code)+"} }")}function compilerCode(code){if(Dep.listInfo){code=code.replace(new RegExp("(\\$"+Dep.listInfo.itemName+"){1}","g"),"__data__."+Dep.listInfo.listKey+"["+Dep.listInfo.index+"]");code=code.replace(new RegExp("(\\$"+Dep.listInfo.indexName+"){1}","g"),Dep.listInfo.index);code=code.replace(new RegExp("(\\$"+Dep.listInfo.listName+"){1}","g"),"__data__."+Dep.listInfo.listKey)}return code}function createFunction(render){try{return new Function(render)}catch(err){console.log(err)}}function objInfo(obj){if(typeof obj==="object"){if(obj.length){return 1}else{return 2}}else{return 0}}function compare(a,b){if((typeof a!=="object"&&a===b)||(typeof a==="object"&&JSON.stringify(a)===JSON.stringify(b))){return true
}else{return false}}function Dep(){this.watchers=[]}Dep.prototype={addWatch:function(watcher){this.watchers.push(watcher)},notify:function(){var deleteW=[];this.watchers.forEach(function(watcher,i){if(watcher.isExpire()){deleteW.push(i)}else{watcher.update()}});if(deleteW.length>0){this.watchers=this.watchers.filter(function(v,i){return deleteW.indexOf(i)===-1})}},getSize:function(){return this.watchers.length}};_ob.arrDep=new Dep();function Watcher(option){Dep.watcher=this;this._sm=option._sm;this.key=option.key;this.node=option.node;this.type=option.type;this.parentNode=option.node.parentNode;this.nextSibling=option.node.nextSibling;this.listNodes=null;if(option.ofList){this.ofList=option.ofList;this.version=_listVer[option.ofList].version}if(option.type==="bind"){this.bindType=option.bindType;this.bindName=option.bindName}this.code=getRender(this.key);this.update=this.update();this.update();Dep.watcher=null}Watcher.prototype={update:function(){var _sm=this._sm,node=this.node,key=this.key,isTrue=undefined;if(this.type==="{{}}"){return function(){this.getVal();node.nodeValue=this.value}}else{if(this.type==="text"){return function(){this.getVal();node.innerText=this.value}}else{if(this.type==="bind"&&this.bindType==="class"){return function(){this.getVal();if(this.value!==isTrue||isTrue===undefined){if(this.value){addClass(node,this.bindName);isTrue=true}else{removeClass(node,this.bindName);isTrue=false}}}}else{if(this.type==="bind"&&this.bindType==="style"){return function(){this.getVal();node.style[this.bindName]=this.value}}else{if(this.type==="bind"&&this.bindType==="attr"){return function(){this.getVal();node.setAttribute(this.bindName,this.value)}}else{if(this.type==="if"){return function(){this.getVal();if(this.value!==isTrue||isTrue===undefined){if(this.value){if(isTrue===undefined){viewScan(node,_sm)}isTrue=true;this.parentNode.insertBefore(node,this.nextSibling)}else{this.parentNode.removeChild(node);isTrue=false}}}}else{if(this.type==="show"){return function(){this.getVal();if(this.value!==isTrue||isTrue===undefined){if(this.value){node.style.display="block";isTrue=true}else{node.style.display="none";isTrue=false}}}}else{if(this.type==="input"){return function(){this.getVal();node.value=this.value}}else{if(this.type==="html"){return function(){this.getVal();node.innerHTML=this.value}}else{if(this.type==="for"){return function(){this.getVal();if(!Dep.watcher){if(compare(_listVer[this.listKey].list,_sm[key])){return}else{_sm.__data__[key]=_sm[key]}}var list=_sm.__data__[key],listLen=list.length;Dep.listLength=listLen;Dep.listInfo={listName:_listName,itemName:_listItemName,indexName:_listIndexName,listKey:key};if(this.listNodes===null){this.listNodes=[];this.listKey=key+getHash();_listVer[this.listKey]={};_listVer[this.listKey].version=0}if(this.listNodes.length>0){this.listNodes.forEach(function(node){node.parentNode.removeChild(node)});_listVer[this.listKey].version++}_listVer[this.listKey].list=list;this.listNodes=[];var newNode;for(var i=0;i<listLen;i++){newNode=node.cloneNode(true);this.listNodes.push(newNode);this.parentNode.insertBefore(newNode,this.nextSibling);Dep.listInfo.index=i;viewScan(newNode,_sm,this.listKey,true)}Dep.listInfo=null}}}}}}}}}}}},getVal:function(){this._sm.render=createFunction(this.code);this.value=this._sm.render()},isExpire:function(){return this.ofList?_listVer[this.ofList].version!==this.version:undefined}};function sm(obj){this.$el=obj.el;this.$data=obj.data;this.__data__=JSON.parse(JSON.stringify(obj.data));for(var key in obj.methods){this[key]=obj.methods[key]}this.created=obj.created;this.mounted=obj.mounted;this._init(this);return this}sm.prototype={$watch:function(key,setter,getter){Object.defineProperty(this.$data,key,{enumerable:true,configurable:true,set:setter,get:getter});Object.defineProperty(this,key,{enumerable:true,configurable:true,set:setter,get:getter})},_init:function(_sm){for(var key in this.$data){watchData(_sm,key,_sm.$data[key])}this.created.call(this);viewScan(document.querySelector(this.$el),this);this.mounted.call(this)}};window.sm=sm}));